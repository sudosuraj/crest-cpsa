{
  "title": "Appendix E: Microsoft Windows Security Assessment",
  "letter": "E",
  "content": "Appendix E: Microsoft Windows Security Assessment\nE1 Domain Reconnaissance\nIdentifying domains/workgroups and domain membership within the target network.\nIdentifying key servers within the target domains.\nIdentifying and analysing internal browse lists.\nIdentifying and analysing accessible SMB shares.\nworkgroups, domain memberships, key servers, internal browse lists, and accessible SMB (Server\nMessage Block) shares within a target network. This reconnaissance is part of the initial phase of ethical\nhacking and security assessments to understand the structure and potential vulnerabilities of the\nnetwork.\nIdentifying Domains/Workgroups and Domain Membership:\n1. Network Scanning:\n• Utilize tools like Nmap to discover active hosts on the network and identify their open\nports.\nnmap -p 135,139,445 <target>\n2. NetBIOS Enumeration:\n• Use tools like nbtscan or enum4linux to enumerate NetBIOS information, including\ndomains and workgroups.\nnbtscan <target>\nenum4linux -A <target>\n3. DNS Zone Transfer:\n• If DNS zone transfers are allowed, attempt to perform a zone transfer to gather\ninformation about the domain.\nnslookup > server <target> > ls -d example.com\nIdentifying Key Servers:\n1. Service Identification:\n• Identify key servers by analyzing open ports and services. Focus on ports commonly\nassociated with domain services, such as 389 (LDAP) and 3268 (Global Catalog).\nnmap -p 389,3268 <target>\n2. LDAP Enumeration:\n• Use LDAP enumeration tools (e.g., ldapsearch) to gather information about the LDAP\ndirectory structure and key servers.\nldapsearch -x -h <target> -b \"dc=example,dc=com\" -s sub -D \"username\" -W\nIdentifying and Analyzing Internal Browse Lists:\n1. NetBIOS Enumeration:\n• Continue to use NetBIOS enumeration tools to gather internal browse lists and\ninformation about neighboring systems.\n\nnbtscan <target>\nenum4linux -A <target>\nIdentifying and Analyzing Accessible SMB Shares:\n1. SMB Enumeration:\n• Use tools like enum4linux or smbmap to identify accessible SMB shares on target\nsystems.\nenum4linux -S <target>\nsmbmap -H <target>\n2. Null Sessions:\n• Attempt null sessions to gather additional information about accessible shares and\npermissions.\nrpcclient -U \"\" <target>\n3. SMB Client Enumeration:\n• Use the SMB client (smbclient) to interactively browse and list shares on the target.\nsmbclient -L //<target>\n\nE2 User Enumeration\nIdentifying user accounts on target systems and domains using NetBIOS, SNMP and LDAP.\nUser enumeration is a common phase in penetration testing and security assessments where the goal is\nto identify user accounts on target systems and domains. Various protocols, such as NetBIOS, SNMP,\nand LDAP, can be leveraged for this purpose. It's important to note that user enumeration should only\nbe performed on systems where you have explicit authorization to do so.\n1. NetBIOS User Enumeration:\nNetBIOS (Network Basic Input/Output System) is an API that allows applications on separate computers\nto communicate. It's often used to identify users and shares on Windows-based systems.\na. nbtscan:\n• Use the nbtscan tool to perform NetBIOS enumeration and identify active hosts, users, and\nshares.\nnbtscan <target>\nb. enum4linux:\n• The enum4linux tool can be used to extract user and group information through NetBIOS.\nenum4linux -U -G -o <target>\n2. SNMP User Enumeration:\nSNMP (Simple Network Management Protocol) is a protocol used for network management. SNMP\nenumeration involves querying SNMP services on devices to extract information, including user\naccounts.\na. SNMP Enumeration Tools:\n• Use SNMP enumeration tools like onesixtyone or snmpwalk to query SNMP devices for user\ninformation.\nonesixtyone -c public <target>\nsnmpwalk -c public -v1 <target> 1.3.6.1.2.1.25.1.5\n3. LDAP User Enumeration:\nLDAP (Lightweight Directory Access Protocol) is a directory service protocol used for accessing and\nmanaging distributed directory information services.\na. ldapsearch:\n• Use the ldapsearch tool to query an LDAP server for user information.\nldapsearch -x -h <target> -b \"dc=example,dc=com\" -s sub -D \"username\" -W\nThis command queries the LDAP server, starting at the base DN (\"dc=example,dc=com\"), and retrieves\nuser information.\n\nE3 Active Directory\nActive Directory Roles (Global Catalogue, Master Browser, FSMO)\nReliance of AD on DNS and LDAP\nGroup Policy (Local Security Policy)\n\nActive Directory Roles:\nActive Directory (AD) is a directory service developed by Microsoft for Windows domain networks. It\nincludes various roles that play critical functions in the network infrastructure.\n1. Global Catalog (GC):\n• The Global Catalog is a distributed data repository that contains a searchable, partial\nrepresentation of every object in every domain within a forest.\n• Importance: It facilitates efficient and fast searches for objects within the entire forest.\n2. FSMO Roles (Flexible Single Master Operations):\n• These are roles that are assigned to one or more domain controllers to manage specific\noperations in an AD forest.\n• Roles:\n• Schema Master: Manages updates to the schema.\n• Domain Naming Master: Manages changes to the forest's domain namespace.\n• RID Master (Relative ID): Allocates unique security identifiers (SIDs) to objects.\n• PDC Emulator (Primary Domain Controller): Provides backward compatibility\nfor earlier Windows NT domain controllers.\n• Infrastructure Master: Manages cross-domain object references.\nReliance of AD on DNS and LDAP:\n1. DNS (Domain Name System):\n• Active Directory heavily relies on DNS for name resolution. AD domains are closely tied\nto DNS namespaces, and DNS is used to locate domain controllers.\n• SRV Records: AD uses DNS SRV records to locate services such as domain controllers\nand global catalog servers.\n2. LDAP (Lightweight Directory Access Protocol):\n• LDAP is the protocol used by AD for accessing and managing directory services. It\nprovides a standard way to communicate with the directory.\n•\n\nLDAP Queries: AD clients and services use LDAP queries to retrieve information from\nthe AD database.\nGroup Policy (Local Security Policy):\n1. Group Policy:\n• Group Policy in Active Directory is a set of rules that control the working environment of\nuser accounts and computer accounts. It allows administrators to manage settings\ncentrally.\n• Key Aspects:\n• Security Settings: Enforce security configurations across the domain.\n• Software Installation: Deploy and manage software installations on client\nmachines.\n• Script Execution: Run scripts on client machines for various purposes.\n• Desktop Settings: Configure desktop environments and user preferences.\n2. Local Security Policy:\n• The Local Security Policy is a standalone tool on Windows machines that allows\nadministrators to configure security settings on an individual machine.\n• Local Policies:\n• Audit Policy: Configure audit settings for the local machine.\n• User Rights Assignment: Define what actions users are allowed to perform on\nthe machine.\n• Security Options: Configure various security-related options.\n# CMD\nnet users %username% #Me\nnet users #All local users\nnet localgroup #Groups\nnet localgroup Administrators #Who is inside Administrators group\nwhoami /all #Check the privileges\n# PS\nGet-WmiObject -Class Win32_UserAccount\nGet-LocalUser\nft Name,Enabled,LastLogon\nGet-ChildItem C:\\Users -Force\nselect Name\nGet-LocalGroupMember Administrators\nft Name, PrincipalSource\n\nE4 Windows Passwords\nPassword policies (complexity, lockout policies)\nAccount Brute Forcing\nHash Storage (merits of LANMAN, NTLMv1 / v2)\nOffline Password Analysis (rainbow tables / hash brute forcing)\nLM Hash\nPrimary Windows LAN hash before Windows NT. 14 character limit.\n\nWindows Passwords:\nPassword Policies:\n1. Complexity Policies:\n• Enforce the use of complex passwords containing a combination of uppercase and\nlowercase letters, numbers, and special characters.\n2. Lockout Policies:\n• Define policies that lock out user accounts after a certain number of incorrect login\nattempts. This helps prevent brute force attacks.\nAccount Brute Forcing:\n1. Brute Force Attacks:\n• Attackers attempt to gain unauthorized access by systematically trying all possible\ncombinations of passwords until the correct one is found.\n• Mitigation: Account lockout policies, CAPTCHAs, and multi-factor authentication (MFA)\ncan help mitigate brute force attacks.\nHash Storage:\nMerits of LANMAN, NTLMv1/v2:\n1. LANMAN (Deprecated):\n• LANMAN (LM) is an older, insecure password hashing algorithm used in older Windows\nsystems.\n• Merits: None from a security standpoint; it's vulnerable to rainbow table attacks.\n2. NTLMv1:\n• NTLMv1 is an improvement over LANMAN but is still vulnerable to certain attacks.\n• Merits: Stronger than LANMAN but susceptible to pass-the-hash attacks.\n3. NTLMv2:\n• NTLMv2 is a more secure version of NTLM and is resistant to pass-the-hash attacks.\n• Merits: Provides stronger security compared to LANMAN and NTLMv1.\nOffline Password Analysis:\nRainbow Tables / Hash Brute Forcing:\n1. Rainbow Tables:\n• Precomputed tables of hash values for all possible password combinations. Attackers\nuse these tables to quickly find the corresponding plaintext for a given hash.\n• Mitigation: Salting passwords before hashing makes precomputed tables less effective.\n2. Hash Brute Forcing:\n• Attackers attempt to guess passwords by hashing potential passwords and comparing\nthe results with stored hash values.\n•\n\nMitigation: Strong password policies, account lockout mechanisms, and monitoring for\nsuspicious activities help mitigate hash brute force attacks.\n3. Here's a table summarizing the information about NTLM versions, including hash\nNTLM\nHash\nSecurity\nVersion Generation Features\n\nExample Hash Format\n\nNTLMv1 MD4\n\nVulnerable\nto certain\nattacks\nAAD3B435B51404EEAAD3B435B51404EE:8846F7EAEE8FB117AD06BDD830B7586C\n\nMD5,\nHMACNTLMv2 MD5\n\nChallengeresponse,\ntime\nstamp, TIB 5FBBAB58D83EFC28:0101000000000000F22CC1490C13E79A:username:DOMAIN\n\nNTLMv2 MD5,\nSession HMACSecurity MD5\n\nSession\nsecurity\n•\n•\n\n6A9FB3450E302FD1FADDA9AD25B4DFF5:0101000000000000C4D1ADAE4A11D501:username:DOMAIN\n\ngeneration, security features, and an example hash format:\nIn the \"Example Hash Format\" column, the placeholders (e.g., <LMHash>, <NTHash>)\nrepresent actual hash components. The example hashes are provided for illustration\npurposes and do not correspond to real passwords or challenges.\n\nLANMAN\nhttps://en.wikipedia.org/wiki/LAN_Manager\nLAN Manager is an obsolete authentication protocol, with its final release in 1994.\nPassword Weakness: 14 characters only, all upper case.\nNew Technology LAN Manager(NTLM)\nhttps://en.wikipedia.org/wiki/NT_LAN_Manager\nNTLM is not recommended to be used by Microsoft since 2010, but it is still widely used and deployed,\nespecially in AD environments.\nFamous attack is pass-the-hash attack, where once we have gotten the NTLM hash, we can use it to get\ninto authenticated places. Used in SMB, and lateral movements.\nhttps://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4\n\nSample NTLM hash\nu4netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a9075\n1cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c\nadmin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315\nc7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31\ncdb3b92f5d765c783030\nSource: Peter Gombos, 20 Feb 2018, \"LM, NTLM, Net-NTLMv2, oh my!\"\nDifferent fields in the LM hash format\nFirst field: the username\nSecond field: the SID (Security IDentifier) for that username\nThird field: the LM hash\nForth field: the NTLM hash\nhttps://vk9-sec.com/windows-password-hashes/\nOffline Password Analysis (rainbow tables / hash brute forcing)\nHydra, John the Ripper with wordlists, Rainbowcrack\nhttps://project-rainbowcrack.com/\nhttps://github.com/vanhauser-thc/thc-hydra\nhttps://tools.kali.org/password-attacks/hydra\n\nE5 Windows Vulnerabilities\nKnowledge of remote windows vulnerabilities, particularly those for which robust exploit code exists in\nthe public domain.\nKnowledge of local windows privilege escalation vulnerabilities and techniques.\nKnowledge of common post exploitation activities:\nobtain password hashes, both from the local SAM and cached credentials\nobtaining locally stored clear text passwords\ncrack password hashes\ncheck patch levels\nderive list of missing security patches\nreversion to previous state\nKnowledge of remote windows vulnerabilities, particularly those for which robust exploit code exists in\nthe public domain.\nName\n\nDesc\n\ncve/ms\n\nEternalBlue\n\nSMB vulerability\n\nms17-010\n\nKnowledge of local windows privilege escalation vulnerabilities and techniques.\nName\n\nDesc\n\ncve/ms/remarks\n\nPass the hash\n\nreuse of\nNTLM\nhash\n\nMimikatz\n\nSilver/Golden\nTicket\n\nreuse of\nNTLM\nhash\n\nMimikatz. Lateral movement.\n\nCached\npasswords\n\n-\n\n-\n\nSession\nHighjacking\n\n-\n\n-\n\nToken\nManipulation\n\n-\n\n-\n\n-\n\nUnquoted service paths are not escaped, and windows will look\nfor the file name without spaces, before it looks for file names\nwith spaces. If a service is called Image Viewer, we might be able\nto execute a payload named \"Image\". Windows will try to run\nImage first, before considering other file names with spaces.\n\nUnquoted\nservice paths\n\nName\n\nDesc\n\ncve/ms/remarks\n\n-\n\nIf we have write permissions to a binary dependency folder used\nby services, we can overite the DLL to a reverse shell payload, or\nother payloads.\n\nRegistry\nmodifications\n\n-\n\nE.g. if in registry a service executes a binary, and we can change\nthe binary location from registry value, we can achieve code\nexecution if it is on elevated privileges.\n\nAutorun\n\n-\n\n-\n\nBad write\npermissions\n\n-\n\n-\n\nDLL\nhighjacking\n\nKnowledge of common post exploitation activities:\n• obtain password hashes, both from the local SAM and cached credentials\n• obtaining locally-stored clear-text passwords\n• crack password hashes\n• check patch levels\n• derive list of missing security patches\n• reversion to previous state\n\nSAM credential dump\nSAM = Security Accounts Manager (SAM) On windows victim machine\nreg save hklm\\system system\nreg save hklm\\sam sam\nOn Attacker Kali\nsamdump2 system sam\n\nHash Cracking\nWe can use hashcat. Hash.txt will have the hashes saved into it.\njohn --format=lm hash.txt\nhashcat -m 3000 -a 3 hash.txt\n\nCheck patch levels\nwmic qfe get Caption,Description,HotFixID,InstalledOn\n\nderive list of missing security patches\nWe can use some vulnerability scanners like Nessus,\nWindowsExploitSuggester. https://msrc.microsoft.com/update-guide\nWorkflow: Check the patches from wmic, see when the latest patch is, refer to windows update patches\nto check the date. The date is useful to help narrow down which exploits we can use. Any exploit\ncreated after the patch date is more likely to work.\nReversion to previous state\nhttps://www.lifewire.com/how-to-start-system-restore-from-the-command-prompt-2624522\nIf system restore data is available, we can try it.\nrstrui.exe\nThis attack vector is rarely seen, but good to know.\nVariable\n\n%SYSTEt~ROOT%\n\nPath\n\nDescription\n\nTypically C:\\Windows\n\nEnvironment variable\nrepresenting the\nsystem root directory.\n\nHosts file that maps IP\n%SYSTEMROOT%\\System32\\drivers\\e C:\\Windows\\System32\\drivers\\etc\\ho addresses to\ntc\\hosts\nsts\nhostnames.\nNetworks file\n%SYSTEMROOT%\\System32\\drivers\\e C:\\Windows\\System32\\drivers\\etc\\ne containing network\ntc\\networks\ntworks\nnames.\n%SYSTEt~ROOT% \\ system32 \\\nconfig\\SAM\n\nC:\\Windows\\system32\\config\\SAM\n\nSecurity Account\nManager containing\nuser password hashes.\n\n%SYSTEMROOT%\\repair\\SAt~\n\nC:\\Windows\\repair\\SAM\n\nBackup copy of the\nSAM file.\n\nBackup copy of the\n%SYSTEMROOT%\\System32\\config\\R C:\\Windows\\System32\\config\\RegBac SAM file from the\negBack\\SAt~\nk\\SAM\nregistry.\n%WINDIR%\\system32\\config\\AppEve C:\\Windows\\system32\\config\\AppEve\nnt.Evt\nnt.Evt\nApplication Event Log.\n%WINDIR%\\system32\\config\\SecEven C:\\Windows\\system32\\config\\SecEve\nt.Evt\nnt.Evt\nSecurity Event Log.\n%ALLUSERSPROFILE%\\Start\nMenu\\Programs\\Startup\\\n\nC:\\ProgramData\\Microsoft\\Windows\\ Startup folder for all\nStart Menu\\Programs\\Startup\nusers.\n\n%USERPROFILE%\\Start\nMenu\\Programs\\Startup\\\n\nC:\\Users<Username>\\AppData\\Roami\nng\\Microsoft\\Windows\\Start\nStartup folder for the\nMenu\\Programs\\Startup\ncurrent user.\n\n%SYSTEMROOT%\\Prefetch\n\nC:\\Windows\\Prefetch\n\nPrefetch directory for\nexecutable logs.\n\nE6 Windows Patch Management Strategies\nKnowledge of common windows patch management strategies:\nSMS\nSUS\nWSUS\nMBSA\n1. SMS (Systems Management Server):\n• Description:\n• SMS, now known as Microsoft System Center Configuration Manager (SCCM), is a\ncomprehensive systems management solution.\n• Originally focused on software distribution, it has evolved to include patch\nmanagement, software deployment, and other management tasks.\n• Patch Management with SMS:\n• SMS/SCCM allows administrators to deploy patches, updates, and software packages\nacross a network.\n• It provides centralized control over the distribution of updates and patches.\n2. SUS (Software Update Services):\n• Description:\n• SUS, which later evolved into Windows Server Update Services (WSUS), is a Microsoft\ntool for managing the distribution of updates released through Microsoft Update to\ncomputers in a corporate environment.\n• Patch Management with SUS:\n• SUS/WSUS allows administrators to deploy updates to Microsoft products.\n• It provides a centralized server for storing and approving updates before distribution to\nclient machines.\n3. WSUS (Windows Server Update Services):\n• Description:\n• WSUS is the successor to SUS and is a Microsoft tool for managing the distribution of\nupdates released through Microsoft Update to computers in a corporate environment.\n• Patch Management with WSUS:\n• WSUS provides a central management console for approving and distributing updates.\n• It allows organizations to control which updates are deployed and when.\n4. MBSA (Microsoft Baseline Security Analyzer):\n• Description:\n• MBSA is a tool designed to identify common security misconfigurations and missing\nsecurity updates across different Microsoft products.\n• Patch Management with MBSA:\n• MBSA scans Windows-based systems for security vulnerabilities and missing patches.\n• It provides reports on the security status of scanned systems and recommendations for\nremediation.\n\nE7 Desktop Lockdown breakout\nKnowledge and understanding of techniques to break out of a locked down Windows desktop / Citrix\nenvironment. Privilege escalation techniques.\nSee E5.\n\nE8 Exchange\nKnowledge of common attack vectors for Microsoft Exchange Server.\nhttps://en.wikipedia.org/wiki/Microsoft_Exchange_Server\nMS Exchange server is a mail exchange server.\nWeak to wordlist credential attacks (credential stuffing).\nAttacks may come from other services in the ASP.NET web framework.\n\nE9 Common Windows Applications\nKnowledge of significant vulnerabilities in common windows applications for which there is public\nexploit code available.\nSome common in Windows Applications vulnerabilities:\nEternalBlue for SMB\nNetBIOS information leakage.\nSMB leakage.\nRDP attacks.\nAnything with anonymous login.",
  "sections": [
    {
      "id": "E1",
      "title": "E1 Domain Reconnaissance",
      "content": "E1 Domain Reconnaissance\nIdentifying domains/workgroups and domain membership within the target network.\nIdentifying key servers within the target domains.\nIdentifying and analysing internal browse lists.\nIdentifying and analysing accessible SMB shares.\nworkgroups, domain memberships, key servers, internal browse lists, and accessible SMB (Server\nMessage Block) shares within a target network. This reconnaissance is part of the initial phase of ethical\nhacking and security assessments to understand the structure and potential vulnerabilities of the\nnetwork.\nIdentifying Domains/Workgroups and Domain Membership:\n1. Network Scanning:\n• Utilize tools like Nmap to discover active hosts on the network and identify their open\nports.\nnmap -p 135,139,445 <target>\n2. NetBIOS Enumeration:\n• Use tools like nbtscan or enum4linux to enumerate NetBIOS information, including\ndomains and workgroups.\nnbtscan <target>\nenum4linux -A <target>\n3. DNS Zone Transfer:\n• If DNS zone transfers are allowed, attempt to perform a zone transfer to gather\ninformation about the domain.\nnslookup > server <target> > ls -d example.com\nIdentifying Key Servers:\n1. Service Identification:\n• Identify key servers by analyzing open ports and services. Focus on ports commonly\nassociated with domain services, such as 389 (LDAP) and 3268 (Global Catalog).\nnmap -p 389,3268 <target>\n2. LDAP Enumeration:\n• Use LDAP enumeration tools (e.g., ldapsearch) to gather information about the LDAP\ndirectory structure and key servers.\nldapsearch -x -h <target> -b \"dc=example,dc=com\" -s sub -D \"username\" -W\nIdentifying and Analyzing Internal Browse Lists:\n1. NetBIOS Enumeration:\n• Continue to use NetBIOS enumeration tools to gather internal browse lists and\ninformation about neighboring systems.\n\nnbtscan <target>\nenum4linux -A <target>\nIdentifying and Analyzing Accessible SMB Shares:\n1. SMB Enumeration:\n• Use tools like enum4linux or smbmap to identify accessible SMB shares on target\nsystems.\nenum4linux -S <target>\nsmbmap -H <target>\n2. Null Sessions:\n• Attempt null sessions to gather additional information about accessible shares and\npermissions.\nrpcclient -U \"\" <target>\n3. SMB Client Enumeration:\n• Use the SMB client (smbclient) to interactively browse and list shares on the target.\nsmbclient -L //<target>"
    },
    {
      "id": "E2",
      "title": "E2 User Enumeration",
      "content": "E2 User Enumeration\nIdentifying user accounts on target systems and domains using NetBIOS, SNMP and LDAP.\nUser enumeration is a common phase in penetration testing and security assessments where the goal is\nto identify user accounts on target systems and domains. Various protocols, such as NetBIOS, SNMP,\nand LDAP, can be leveraged for this purpose. It's important to note that user enumeration should only\nbe performed on systems where you have explicit authorization to do so.\n1. NetBIOS User Enumeration:\nNetBIOS (Network Basic Input/Output System) is an API that allows applications on separate computers\nto communicate. It's often used to identify users and shares on Windows-based systems.\na. nbtscan:\n• Use the nbtscan tool to perform NetBIOS enumeration and identify active hosts, users, and\nshares.\nnbtscan <target>\nb. enum4linux:\n• The enum4linux tool can be used to extract user and group information through NetBIOS.\nenum4linux -U -G -o <target>\n2. SNMP User Enumeration:\nSNMP (Simple Network Management Protocol) is a protocol used for network management. SNMP\nenumeration involves querying SNMP services on devices to extract information, including user\naccounts.\na. SNMP Enumeration Tools:\n• Use SNMP enumeration tools like onesixtyone or snmpwalk to query SNMP devices for user\ninformation.\nonesixtyone -c public <target>\nsnmpwalk -c public -v1 <target> 1.3.6.1.2.1.25.1.5\n3. LDAP User Enumeration:\nLDAP (Lightweight Directory Access Protocol) is a directory service protocol used for accessing and\nmanaging distributed directory information services.\na. ldapsearch:\n• Use the ldapsearch tool to query an LDAP server for user information.\nldapsearch -x -h <target> -b \"dc=example,dc=com\" -s sub -D \"username\" -W\nThis command queries the LDAP server, starting at the base DN (\"dc=example,dc=com\"), and retrieves\nuser information."
    },
    {
      "id": "E3",
      "title": "E3 Active Directory",
      "content": "E3 Active Directory\nActive Directory Roles (Global Catalogue, Master Browser, FSMO)\nReliance of AD on DNS and LDAP\nGroup Policy (Local Security Policy)\n\nActive Directory Roles:\nActive Directory (AD) is a directory service developed by Microsoft for Windows domain networks. It\nincludes various roles that play critical functions in the network infrastructure.\n1. Global Catalog (GC):\n• The Global Catalog is a distributed data repository that contains a searchable, partial\nrepresentation of every object in every domain within a forest.\n• Importance: It facilitates efficient and fast searches for objects within the entire forest.\n2. FSMO Roles (Flexible Single Master Operations):\n• These are roles that are assigned to one or more domain controllers to manage specific\noperations in an AD forest.\n• Roles:\n• Schema Master: Manages updates to the schema.\n• Domain Naming Master: Manages changes to the forest's domain namespace.\n• RID Master (Relative ID): Allocates unique security identifiers (SIDs) to objects.\n• PDC Emulator (Primary Domain Controller): Provides backward compatibility\nfor earlier Windows NT domain controllers.\n• Infrastructure Master: Manages cross-domain object references.\nReliance of AD on DNS and LDAP:\n1. DNS (Domain Name System):\n• Active Directory heavily relies on DNS for name resolution. AD domains are closely tied\nto DNS namespaces, and DNS is used to locate domain controllers.\n• SRV Records: AD uses DNS SRV records to locate services such as domain controllers\nand global catalog servers.\n2. LDAP (Lightweight Directory Access Protocol):\n• LDAP is the protocol used by AD for accessing and managing directory services. It\nprovides a standard way to communicate with the directory.\n•\n\nLDAP Queries: AD clients and services use LDAP queries to retrieve information from\nthe AD database.\nGroup Policy (Local Security Policy):\n1. Group Policy:\n• Group Policy in Active Directory is a set of rules that control the working environment of\nuser accounts and computer accounts. It allows administrators to manage settings\ncentrally.\n• Key Aspects:\n• Security Settings: Enforce security configurations across the domain.\n• Software Installation: Deploy and manage software installations on client\nmachines.\n• Script Execution: Run scripts on client machines for various purposes.\n• Desktop Settings: Configure desktop environments and user preferences.\n2. Local Security Policy:\n• The Local Security Policy is a standalone tool on Windows machines that allows\nadministrators to configure security settings on an individual machine.\n• Local Policies:\n• Audit Policy: Configure audit settings for the local machine.\n• User Rights Assignment: Define what actions users are allowed to perform on\nthe machine.\n• Security Options: Configure various security-related options.\n# CMD\nnet users %username% #Me\nnet users #All local users\nnet localgroup #Groups\nnet localgroup Administrators #Who is inside Administrators group\nwhoami /all #Check the privileges\n# PS\nGet-WmiObject -Class Win32_UserAccount\nGet-LocalUser\nft Name,Enabled,LastLogon\nGet-ChildItem C:\\Users -Force\nselect Name\nGet-LocalGroupMember Administrators\nft Name, PrincipalSource"
    },
    {
      "id": "E4",
      "title": "E4 Windows Passwords",
      "content": "E4 Windows Passwords\nPassword policies (complexity, lockout policies)\nAccount Brute Forcing\nHash Storage (merits of LANMAN, NTLMv1 / v2)\nOffline Password Analysis (rainbow tables / hash brute forcing)\nLM Hash\nPrimary Windows LAN hash before Windows NT. 14 character limit.\n\nWindows Passwords:\nPassword Policies:\n1. Complexity Policies:\n• Enforce the use of complex passwords containing a combination of uppercase and\nlowercase letters, numbers, and special characters.\n2. Lockout Policies:\n• Define policies that lock out user accounts after a certain number of incorrect login\nattempts. This helps prevent brute force attacks.\nAccount Brute Forcing:\n1. Brute Force Attacks:\n• Attackers attempt to gain unauthorized access by systematically trying all possible\ncombinations of passwords until the correct one is found.\n• Mitigation: Account lockout policies, CAPTCHAs, and multi-factor authentication (MFA)\ncan help mitigate brute force attacks.\nHash Storage:\nMerits of LANMAN, NTLMv1/v2:\n1. LANMAN (Deprecated):\n• LANMAN (LM) is an older, insecure password hashing algorithm used in older Windows\nsystems.\n• Merits: None from a security standpoint; it's vulnerable to rainbow table attacks.\n2. NTLMv1:\n• NTLMv1 is an improvement over LANMAN but is still vulnerable to certain attacks.\n• Merits: Stronger than LANMAN but susceptible to pass-the-hash attacks.\n3. NTLMv2:\n• NTLMv2 is a more secure version of NTLM and is resistant to pass-the-hash attacks.\n• Merits: Provides stronger security compared to LANMAN and NTLMv1.\nOffline Password Analysis:\nRainbow Tables / Hash Brute Forcing:\n1. Rainbow Tables:\n• Precomputed tables of hash values for all possible password combinations. Attackers\nuse these tables to quickly find the corresponding plaintext for a given hash.\n• Mitigation: Salting passwords before hashing makes precomputed tables less effective.\n2. Hash Brute Forcing:\n• Attackers attempt to guess passwords by hashing potential passwords and comparing\nthe results with stored hash values.\n•\n\nMitigation: Strong password policies, account lockout mechanisms, and monitoring for\nsuspicious activities help mitigate hash brute force attacks.\n3. Here's a table summarizing the information about NTLM versions, including hash\nNTLM\nHash\nSecurity\nVersion Generation Features\n\nExample Hash Format\n\nNTLMv1 MD4\n\nVulnerable\nto certain\nattacks\nAAD3B435B51404EEAAD3B435B51404EE:8846F7EAEE8FB117AD06BDD830B7586C\n\nMD5,\nHMACNTLMv2 MD5\n\nChallengeresponse,\ntime\nstamp, TIB 5FBBAB58D83EFC28:0101000000000000F22CC1490C13E79A:username:DOMAIN\n\nNTLMv2 MD5,\nSession HMACSecurity MD5\n\nSession\nsecurity\n•\n•\n\n6A9FB3450E302FD1FADDA9AD25B4DFF5:0101000000000000C4D1ADAE4A11D501:username:DOMAIN\n\ngeneration, security features, and an example hash format:\nIn the \"Example Hash Format\" column, the placeholders (e.g., <LMHash>, <NTHash>)\nrepresent actual hash components. The example hashes are provided for illustration\npurposes and do not correspond to real passwords or challenges.\n\nLANMAN\nhttps://en.wikipedia.org/wiki/LAN_Manager\nLAN Manager is an obsolete authentication protocol, with its final release in 1994.\nPassword Weakness: 14 characters only, all upper case.\nNew Technology LAN Manager(NTLM)\nhttps://en.wikipedia.org/wiki/NT_LAN_Manager\nNTLM is not recommended to be used by Microsoft since 2010, but it is still widely used and deployed,\nespecially in AD environments.\nFamous attack is pass-the-hash attack, where once we have gotten the NTLM hash, we can use it to get\ninto authenticated places. Used in SMB, and lateral movements.\nhttps://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4\n\nSample NTLM hash\nu4netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a9075\n1cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c\nadmin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315\nc7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31\ncdb3b92f5d765c783030\nSource: Peter Gombos, 20 Feb 2018, \"LM, NTLM, Net-NTLMv2, oh my!\"\nDifferent fields in the LM hash format\nFirst field: the username\nSecond field: the SID (Security IDentifier) for that username\nThird field: the LM hash\nForth field: the NTLM hash\nhttps://vk9-sec.com/windows-password-hashes/\nOffline Password Analysis (rainbow tables / hash brute forcing)\nHydra, John the Ripper with wordlists, Rainbowcrack\nhttps://project-rainbowcrack.com/\nhttps://github.com/vanhauser-thc/thc-hydra\nhttps://tools.kali.org/password-attacks/hydra"
    },
    {
      "id": "E5",
      "title": "E5 Windows Vulnerabilities",
      "content": "E5 Windows Vulnerabilities\nKnowledge of remote windows vulnerabilities, particularly those for which robust exploit code exists in\nthe public domain.\nKnowledge of local windows privilege escalation vulnerabilities and techniques.\nKnowledge of common post exploitation activities:\nobtain password hashes, both from the local SAM and cached credentials\nobtaining locally stored clear text passwords\ncrack password hashes\ncheck patch levels\nderive list of missing security patches\nreversion to previous state\nKnowledge of remote windows vulnerabilities, particularly those for which robust exploit code exists in\nthe public domain.\nName\n\nDesc\n\ncve/ms\n\nEternalBlue\n\nSMB vulerability\n\nms17-010\n\nKnowledge of local windows privilege escalation vulnerabilities and techniques.\nName\n\nDesc\n\ncve/ms/remarks\n\nPass the hash\n\nreuse of\nNTLM\nhash\n\nMimikatz\n\nSilver/Golden\nTicket\n\nreuse of\nNTLM\nhash\n\nMimikatz. Lateral movement.\n\nCached\npasswords\n\n-\n\n-\n\nSession\nHighjacking\n\n-\n\n-\n\nToken\nManipulation\n\n-\n\n-\n\n-\n\nUnquoted service paths are not escaped, and windows will look\nfor the file name without spaces, before it looks for file names\nwith spaces. If a service is called Image Viewer, we might be able\nto execute a payload named \"Image\". Windows will try to run\nImage first, before considering other file names with spaces.\n\nUnquoted\nservice paths\n\nName\n\nDesc\n\ncve/ms/remarks\n\n-\n\nIf we have write permissions to a binary dependency folder used\nby services, we can overite the DLL to a reverse shell payload, or\nother payloads.\n\nRegistry\nmodifications\n\n-\n\nE.g. if in registry a service executes a binary, and we can change\nthe binary location from registry value, we can achieve code\nexecution if it is on elevated privileges.\n\nAutorun\n\n-\n\n-\n\nBad write\npermissions\n\n-\n\n-\n\nDLL\nhighjacking\n\nKnowledge of common post exploitation activities:\n• obtain password hashes, both from the local SAM and cached credentials\n• obtaining locally-stored clear-text passwords\n• crack password hashes\n• check patch levels\n• derive list of missing security patches\n• reversion to previous state\n\nSAM credential dump\nSAM = Security Accounts Manager (SAM) On windows victim machine\nreg save hklm\\system system\nreg save hklm\\sam sam\nOn Attacker Kali\nsamdump2 system sam\n\nHash Cracking\nWe can use hashcat. Hash.txt will have the hashes saved into it.\njohn --format=lm hash.txt\nhashcat -m 3000 -a 3 hash.txt\n\nCheck patch levels\nwmic qfe get Caption,Description,HotFixID,InstalledOn\n\nderive list of missing security patches\nWe can use some vulnerability scanners like Nessus,\nWindowsExploitSuggester. https://msrc.microsoft.com/update-guide\nWorkflow: Check the patches from wmic, see when the latest patch is, refer to windows update patches\nto check the date. The date is useful to help narrow down which exploits we can use. Any exploit\ncreated after the patch date is more likely to work.\nReversion to previous state\nhttps://www.lifewire.com/how-to-start-system-restore-from-the-command-prompt-2624522\nIf system restore data is available, we can try it.\nrstrui.exe\nThis attack vector is rarely seen, but good to know.\nVariable\n\n%SYSTEt~ROOT%\n\nPath\n\nDescription\n\nTypically C:\\Windows\n\nEnvironment variable\nrepresenting the\nsystem root directory.\n\nHosts file that maps IP\n%SYSTEMROOT%\\System32\\drivers\\e C:\\Windows\\System32\\drivers\\etc\\ho addresses to\ntc\\hosts\nsts\nhostnames.\nNetworks file\n%SYSTEMROOT%\\System32\\drivers\\e C:\\Windows\\System32\\drivers\\etc\\ne containing network\ntc\\networks\ntworks\nnames.\n%SYSTEt~ROOT% \\ system32 \\\nconfig\\SAM\n\nC:\\Windows\\system32\\config\\SAM\n\nSecurity Account\nManager containing\nuser password hashes.\n\n%SYSTEMROOT%\\repair\\SAt~\n\nC:\\Windows\\repair\\SAM\n\nBackup copy of the\nSAM file.\n\nBackup copy of the\n%SYSTEMROOT%\\System32\\config\\R C:\\Windows\\System32\\config\\RegBac SAM file from the\negBack\\SAt~\nk\\SAM\nregistry.\n%WINDIR%\\system32\\config\\AppEve C:\\Windows\\system32\\config\\AppEve\nnt.Evt\nnt.Evt\nApplication Event Log.\n%WINDIR%\\system32\\config\\SecEven C:\\Windows\\system32\\config\\SecEve\nt.Evt\nnt.Evt\nSecurity Event Log.\n%ALLUSERSPROFILE%\\Start\nMenu\\Programs\\Startup\\\n\nC:\\ProgramData\\Microsoft\\Windows\\ Startup folder for all\nStart Menu\\Programs\\Startup\nusers.\n\n%USERPROFILE%\\Start\nMenu\\Programs\\Startup\\\n\nC:\\Users<Username>\\AppData\\Roami\nng\\Microsoft\\Windows\\Start\nStartup folder for the\nMenu\\Programs\\Startup\ncurrent user.\n\n%SYSTEMROOT%\\Prefetch\n\nC:\\Windows\\Prefetch\n\nPrefetch directory for\nexecutable logs."
    },
    {
      "id": "E6",
      "title": "E6 Windows Patch Management Strategies",
      "content": "E6 Windows Patch Management Strategies\nKnowledge of common windows patch management strategies:\nSMS\nSUS\nWSUS\nMBSA\n1. SMS (Systems Management Server):\n• Description:\n• SMS, now known as Microsoft System Center Configuration Manager (SCCM), is a\ncomprehensive systems management solution.\n• Originally focused on software distribution, it has evolved to include patch\nmanagement, software deployment, and other management tasks.\n• Patch Management with SMS:\n• SMS/SCCM allows administrators to deploy patches, updates, and software packages\nacross a network.\n• It provides centralized control over the distribution of updates and patches.\n2. SUS (Software Update Services):\n• Description:\n• SUS, which later evolved into Windows Server Update Services (WSUS), is a Microsoft\ntool for managing the distribution of updates released through Microsoft Update to\ncomputers in a corporate environment.\n• Patch Management with SUS:\n• SUS/WSUS allows administrators to deploy updates to Microsoft products.\n• It provides a centralized server for storing and approving updates before distribution to\nclient machines.\n3. WSUS (Windows Server Update Services):\n• Description:\n• WSUS is the successor to SUS and is a Microsoft tool for managing the distribution of\nupdates released through Microsoft Update to computers in a corporate environment.\n• Patch Management with WSUS:\n• WSUS provides a central management console for approving and distributing updates.\n• It allows organizations to control which updates are deployed and when.\n4. MBSA (Microsoft Baseline Security Analyzer):\n• Description:\n• MBSA is a tool designed to identify common security misconfigurations and missing\nsecurity updates across different Microsoft products.\n• Patch Management with MBSA:\n• MBSA scans Windows-based systems for security vulnerabilities and missing patches.\n• It provides reports on the security status of scanned systems and recommendations for\nremediation."
    },
    {
      "id": "E7",
      "title": "E7 Desktop Lockdown breakout",
      "content": "E7 Desktop Lockdown breakout\nKnowledge and understanding of techniques to break out of a locked down Windows desktop / Citrix\nenvironment. Privilege escalation techniques.\nSee E5."
    },
    {
      "id": "E8",
      "title": "E8 Exchange",
      "content": "E8 Exchange\nKnowledge of common attack vectors for Microsoft Exchange Server.\nhttps://en.wikipedia.org/wiki/Microsoft_Exchange_Server\nMS Exchange server is a mail exchange server.\nWeak to wordlist credential attacks (credential stuffing).\nAttacks may come from other services in the ASP.NET web framework."
    },
    {
      "id": "E9",
      "title": "E9 Common Windows Applications",
      "content": "E9 Common Windows Applications\nKnowledge of significant vulnerabilities in common windows applications for which there is public\nexploit code available.\nSome common in Windows Applications vulnerabilities:\nEternalBlue for SMB\nNetBIOS information leakage.\nSMB leakage.\nRDP attacks.\nAnything with anonymous login."
    }
  ]
}